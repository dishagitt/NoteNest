<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Notes App</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      // Toggle profile dropdown (onclick)
      function toggleDropdown(ev) {
        // prevent the document click handler from immediately closing it
        if (ev) ev.stopPropagation();
        document.getElementById("profileDropdown").classList.toggle("hidden");
      }

      // Toggle popup (open/close modal)
      function togglePopup(ev) {
        if (ev) ev.stopPropagation();
        const popup = document.getElementById("popup");
        popup.classList.toggle("hidden");
        popup.classList.toggle("flex");
      }

      // Close handlers: click outside closes dropdown and modal; Esc closes modal
      document.addEventListener("click", function (e) {
        const profileDropdown = document.getElementById("profileDropdown");
        if (profileDropdown && !e.target.closest("#profileMenu")) {
          profileDropdown.classList.add("hidden");
        }

        const popup = document.getElementById("popup");
        const modal = document.getElementById("popupModal");
        if (popup && !popup.classList.contains("hidden")) {
          // if click outside modal content, close modal
          if (!e.target.closest("#popupModal")) {
            // hide popup
            popup.classList.add("hidden");
            popup.classList.remove("flex");
          }
        }
      });

      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          const popup = document.getElementById("popup");
          if (popup && !popup.classList.contains("hidden")) {
            popup.classList.add("hidden");
            popup.classList.remove("flex");
          }
        }
      });
    </script>
  </head>

  <body class="bg-gradient-to-br from-gray-900 via-blue-950 to-black text-gray-100 min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-gradient-to-r from-cyan-700 to-blue-900 shadow-md flex justify-between items-center px-6 py-3">
      <div class="text-lg font-semibold">Hello, {{fname}}</div>
      <div class="text-2xl font-bold tracking-wide text-cyan-300 mr-16">NoteNest</div>

      <!-- Profile menu -->
      <div id="profileMenu" class="relative">
        <img
          src="{{ url_for('static', filename='images/user.png') }}"
          alt="Profile"
          class="w-10 h-10 rounded-full border-2 border-white cursor-pointer"
          onclick="toggleDropdown(event)"
        />
        <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-gray-800 text-gray-100 rounded-md shadow-lg hidden z-50">
          <!-- Use type="button" and stop propagation when opening modal, then close dropdown -->
          <button
            type="button"
            onclick="event.stopPropagation(); togglePopup(); document.getElementById('profileDropdown').classList.add('hidden');"
            class="w-full text-left px-4 py-2 hover:bg-cyan-700"
          >
            Change Password
          </button>

          <a href="{{ url_for('logout') }}" class="block px-4 py-2 hover:bg-cyan-700">Logout</a>
        </div>
      </div>
    </nav>

    <!-- Handle flashes once and capture change-password errors to auto-open modal if needed -->
    {% set flashed = get_flashed_messages(with_categories=true) %}
    {% set _ns = namespace(cp=False, cp_msg='') %}
    {% for category, message in flashed %}
      {% if category == 'change_password_error' %}
        {% set _ns.cp = True %}
        {% set _ns.cp_msg = message %}
      {% endif %}
    {% endfor %}

    <!-- General flash messages (not change_password_error) -->
    <div class="w-6/12 mx-auto mt-4">
      {% for category, message in flashed %}
        {% if category != 'change_password_error' %}
          <div class="my-2 px-4 py-2 rounded-lg shadow-md
            {% if category == 'error' %} bg-red-900 text-red-200 border-l-4 border-red-500
            {% elif category == 'info' %} bg-blue-900 text-blue-200 border-l-4 border-blue-500
            {% else %} bg-gray-800 text-gray-100 {% endif %}">
            {{ message }}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Main Content (wider: 90% of viewport) -->
    <main class="flex-grow mx-auto px-6 py-8 space-y-8 w-6/12">

      <!-- Add Note Form Card (wide) -->
      <div class="bg-gray-900 shadow-lg rounded-xl p-8 w-full">
        <h1 class="text-2xl font-bold text-cyan-400 mb-6 text-center">Add a Note</h1>
        <form method="POST" action="{{ url_for('notesApp') }}" class="space-y-4">
          <input
            name="title"
            type="text"
            placeholder="Title"
            required
            class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:ring-2 focus:ring-cyan-500 focus:outline-none"
          />
          <textarea
            name="content"
            placeholder="Write your note..."
            required
            class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:ring-2 focus:ring-cyan-500 focus:outline-none min-h-[120px] resize-y"
          ></textarea>
          <button
            type="submit"
            class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-full shadow-md transition"
          >
            Add Note
          </button>
        </form>
      </div>

      <!-- Notes Table Card (wide) -->
      <div class="bg-gray-900 shadow-lg rounded-xl p-8 w-full">
        <h2 class="text-2xl font-bold text-cyan-400 mb-6 text-center">Your Notes</h2>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-cyan-700 text-white">
                <th class="px-5 py-3 align-middle text-left">No.</th>
                <th class="px-5 py-3 align-middle text-left">Title</th>
                <th class="px-5 py-3 align-middle text-left">Content</th>
                <th class="px-5 py-3 align-middle text-center">Edit</th>
                <th class="px-5 py-3 align-middle text-center">Delete</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
                <tr class="border-b border-gray-700 hover:bg-gray-800 transition">
                  <td class="px-5 py-3 align-middle">{{ loop.index }}</td>
                  <td class="px-5 py-3 align-middle">{{ item[1] }}</td>
                  <td class="px-5 py-3 align-middle">{{ item[2] }}</td>
                  <td class="px-5 py-3 align-middle text-center">
                    <form action="{{ url_for('editPage', id=item[0]) }}" method="GET">
                      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Edit</button>
                    </form>
                  </td>
                  <td class="px-5 py-3 align-middle text-center">
                    <form method="POST" action="{{ url_for('delete', id=item[0]) }}">
                      <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
                    </form>
                  </td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="5" class="px-5 py-3 text-center text-gray-400">No notes yet!</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Change Password Modal (JS toggled). modal content has id=popupModal for outside-click detection -->
    <div id="popup" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden justify-center items-center z-50">
      <div id="popupModal" class="bg-gray-900 text-gray-100 rounded-lg shadow-xl max-w-md w-full p-6 relative">
        <button type="button" onclick="togglePopup()" class="absolute top-3 right-4 text-2xl font-bold text-gray-400 hover:text-white">&times;</button>
        <h2 class="text-xl font-semibold mb-4 text-cyan-400">Change Password</h2>

        <!-- show change_password_error inside modal if present -->
        {% if _ns.cp %}
          <div class="mb-3 p-3 rounded-md bg-red-900 text-red-200 border-l-4 border-red-500">
            {{ _ns.cp_msg }}
          </div>
        {% endif %}

        <form method="POST" action="{{ url_for('change_password') }}" class="space-y-3">
          <div>
            <label for="current" class="block mb-1">Current Password</label>
            <input id="current" name="current_password" type="password" required
                   class="w-full p-2 rounded bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-cyan-500" />
          </div>

          <div>
            <label for="newpass" class="block mb-1">New Password</label>
            <input id="newpass" name="new_password" type="password" required
                   class="w-full p-2 rounded bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-cyan-500" />
          </div>

          <div>
            <label for="confirm" class="block mb-1">Confirm New Password</label>
            <input id="confirm" name="confirm_password" type="password" required
                   class="w-full p-2 rounded bg-gray-800 border border-gray-700 focus:ring-2 focus:ring-cyan-500" />
          </div>

          <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded mt-3">Save</button>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-blue-950 text-white text-center py-3 mt-auto">
      Â© 2025 Disha Prajapati. All rights reserved.
    </footer>

    <!-- Auto-open modal when server flashed change_password_error -->
    <script>
      (function () {
        const shouldOpen = {{ 'true' if _ns.cp else 'false' }};
        if (shouldOpen) {
          // open modal on page load so user sees server-side validation errors
          const popup = document.getElementById('popup');
          popup.classList.remove('hidden');
          popup.classList.add('flex');
        }
      })();
    </script>
  </body>
</html>
